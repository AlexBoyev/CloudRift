pipeline {
    agent any
    
    triggers {
        githubPush()
    }
    
    options {
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 1, unit: 'HOURS')
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    try {
                        checkout scm
                        sh '''
                            echo "Current directory: $(pwd)"
                            echo "Directory contents:"
                            ls -la
                            echo "Current branch: $(git branch --show-current)"
                            echo "Current commit: $(git rev-parse HEAD)"
                        '''
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'
                        error "Failed to checkout code: ${e.message}"
                    }
                }
            }
        }

        stage('Setup Python Environment') {
            steps {
                script {
                    try {
                        sh '''
                            echo "System Python version:"
                            python3 --version
                            
                            echo "Creating virtual environment..."
                            rm -rf .venv
                            python3 -m venv .venv
                            
                            echo "Activating virtual environment..."
                            source .venv/bin/activate
                            
                            echo "Upgrading pip..."
                            pip install --upgrade pip
                        '''
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'
                        error "Failed to setup Python environment: ${e.message}"
                    }
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    try {
                        sh '''
                            source .venv/bin/activate
                            
                            # Print directory structure before adjusting PYTHONPATH
                            echo "Workspace contents:"
                            ls -la
                            
                            # Add parent directory to PYTHONPATH
                            export PYTHONPATH=$PWD
                            
                            echo "PYTHONPATH: $PYTHONPATH"
                            echo "Directory structure:"
                            ls -R
                            
                            # Run tests
                            cd Testing/Tree
                            python3 tree-testing.py
                        '''
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'
                        error "Tests failed: ${e.message}"
                    }
                }
            }
        }
    }

    post {
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed! Check the logs for details.'
        }
        always {
            script {
                cleanWs(
                    cleanWhenSuccess: true,
                    cleanWhenFailure: true,
                    cleanWhenAborted: true,
                    deleteDirs: true
                )
                sh '''
                    if [ -d ".venv" ]; then
                        rm -rf .venv
                    fi
                '''
            }
        }
    }
}
